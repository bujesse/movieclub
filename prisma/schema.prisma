generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// A list of movies created by a user
model MovieList {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  createdBy   String
  movies      Movie[]
  votes       Vote[]
  comments    Comment[]
  nominations Nomination[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  Meetup      Meetup?

  @@index([createdBy])
  @@index([createdAt])
}

// Individual movies in a list
model Movie {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int

  // TMDb identity
  tmdbId Int

  // Titles & language
  title            String
  originalTitle    String?
  originalLanguage String? // keep plain for SQLite

  // Dates & details
  releaseDate DateTime?
  overview    String?
  voteAverage Float?
  voteCount   Int?

  // Media paths (raw TMDb paths, not full URLs)
  posterPath   String? // e.g. "/abc123.jpg"
  backdropPath String?

  // Genres (JSON array of ints: [28, 12, ...])
  genres Json?

  // Additional details from TMDb
  runtime           Int?
  popularity        Int?
  budget            Int?
  revenue           Int?
  original_language String?
  directors         Json?
  actors            Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Allow same TMDb movie in different lists, but only once per list
  @@unique([movieListId, tmdbId])
  // Handy indexes
  @@index([tmdbId])
  @@index([title])
  @@index([releaseDate])
}

// Votes on a MovieList
model Vote {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  value       Int // 1 or -1
  createdAt   DateTime  @default(now())

  // tie each vote to a specific meetup
  meetup   Meetup @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  meetupId Int

  // Prevent multiple votes by same user on a list
  @@unique([movieListId, userId, meetupId])
  @@index([userId, meetupId])
}

model Meetup {
  id   Int       @id @default(autoincrement()) // singleton row
  date DateTime? // stored in UTC;

  movieList   MovieList?   @relation(fields: [movieListId], references: [id])
  movieListId Int?         @unique
  Vote        Vote[]
  nominations Nomination[]
}

model Nomination {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  createdAt   DateTime  @default(now())

  meetup   Meetup @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  meetupId Int

  @@unique([userId, meetupId])
  @@index([movieListId, meetupId])
  @@index([userId, meetupId])
}

model Seen {
  userId String
  tmdbId Int

  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now()) @updatedAt

  @@id([userId, tmdbId])
  @@index([tmdbId])
  @@index([userId])
}

// Comments on a MovieList
model Comment {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  text        String
  createdAt   DateTime  @default(now())

  @@index([movieListId])
  @@index([userId])
}

// Oscar nomination data (global per movie)
model OscarNomination {
  id              Int      @id @default(autoincrement())

  // Identity fields
  tmdbId          Int?     // Can be null if TMDB lookup failed
  imdbId          String   // Always present from CSV (e.g., "tt0019217")

  // CSV fields - full data preservation
  ceremony        Int      // 1, 2, 3... 97
  year            String   // "1927/28", "2024"
  class           String   // "Acting", "Production", "Directing"
  canonicalCategory String // "ACTOR IN A LEADING ROLE"
  category        String   // "ACTOR", "ACTRESS"
  nomId           String   // "an0051251"
  film            String   // "The Noose"
  name            String?  // Nominee name (e.g., "Richard Barthelmess")
  nominees        String?  // Full nominees string
  nomineeIds      String?  // IMDB IDs of people
  winner          Boolean  @default(false)
  detail          String?  // Additional details
  note            String?  // Notes
  citation        String?  // Citation text
  multifilmNomination Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tmdbId])
  @@index([imdbId])
  @@unique([nomId])
}

// Pre-aggregated Oscar counts for performance
model OscarMovieSummary {
  id              Int      @id @default(autoincrement())
  tmdbId          Int      @unique
  imdbId          String
  totalNominations Int     @default(0)
  totalWins       Int      @default(0)

  // Category breakdowns (JSON for flexibility)
  categoryBreakdown Json?  // { "Acting": { "nominations": 3, "wins": 1 }, ... }

  updatedAt       DateTime @updatedAt

  @@index([tmdbId])
}
