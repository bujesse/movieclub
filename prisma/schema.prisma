generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// A list of movies created by a user
model MovieList {
  id          Int               @id @default(autoincrement())
  title       String
  description String?
  createdBy   String
  movies      MovieListMovie[]  // Changed to junction table
  votes       Vote[]
  comments    Comment[]
  nominations Nomination[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  Meetup      Meetup?

  @@index([createdBy])
  @@index([createdAt])
}

// Global movie table - single source of truth for movie data
model GlobalMovie {
  id          Int       @id @default(autoincrement())
  tmdbId      Int       @unique

  // Titles & language
  title            String
  originalTitle    String?
  originalLanguage String?

  // Dates & details
  releaseDate DateTime?
  overview    String?
  voteAverage Float?
  voteCount   Int?

  // Media paths (raw TMDb paths, not full URLs)
  posterPath   String?
  backdropPath String?

  // Genres (JSON array of ints: [28, 12, ...])
  genres Json?

  // Additional details from TMDb
  runtime           Int?
  popularity        Int?
  budget            Int?
  revenue           Int?
  original_language String?
  directors         Json?
  actors            Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  movieListMovies  MovieListMovie[]
  collectionMovies CollectionMovie[]

  @@index([tmdbId])
  @@index([title])
  @@index([releaseDate])
}

// Junction table: MovieList <-> GlobalMovie (many-to-many)
model MovieListMovie {
  id          Int         @id @default(autoincrement())
  movieList   MovieList   @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  movie       GlobalMovie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  movieId     Int

  // Ordering within list
  order Int @default(0)

  createdAt DateTime @default(now())

  @@unique([movieListId, movieId])
  @@index([movieListId])
  @@index([movieId])
}

// Collection model for curated movie lists (e.g., IMDB Top 250)
model Collection {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?
  letterboxdUrl String?  // Source URL path (e.g., "imdb-top-250")

  // Access control
  createdBy String
  isGlobal  Boolean @default(false) // True for admin-created, false for user collections

  // Sync metadata
  lastSyncedAt DateTime?
  movieCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  movies CollectionMovie[]

  @@index([createdBy])
  @@index([isGlobal])
}

// Junction table: Collection <-> GlobalMovie (many-to-many)
model CollectionMovie {
  id           Int         @id @default(autoincrement())
  collection   Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId Int
  movie        GlobalMovie @relation(fields: [movieId], references: [id], onDelete: Cascade)
  movieId      Int

  // Ordering within collection
  order Int @default(0)

  createdAt DateTime @default(now())

  @@unique([collectionId, movieId])
  @@index([collectionId])
  @@index([movieId])
}

// Votes on a MovieList
model Vote {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  value       Int // 1 or -1
  createdAt   DateTime  @default(now())

  // tie each vote to a specific meetup
  meetup   Meetup @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  meetupId Int

  // Prevent multiple votes by same user on a list
  @@unique([movieListId, userId, meetupId])
  @@index([userId, meetupId])
}

model Meetup {
  id   Int       @id @default(autoincrement()) // singleton row
  date DateTime? // stored in UTC;

  movieList   MovieList?   @relation(fields: [movieListId], references: [id])
  movieListId Int?         @unique
  Vote        Vote[]
  nominations Nomination[]
}

model Nomination {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  createdAt   DateTime  @default(now())

  meetup   Meetup @relation(fields: [meetupId], references: [id], onDelete: Cascade)
  meetupId Int

  @@unique([userId, meetupId])
  @@index([movieListId, meetupId])
  @@index([userId, meetupId])
}

model Seen {
  userId String
  tmdbId Int

  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @default(now()) @updatedAt

  @@id([userId, tmdbId])
  @@index([tmdbId])
  @@index([userId])
}

// Comments on a MovieList
model Comment {
  id          Int       @id @default(autoincrement())
  movieList   MovieList @relation(fields: [movieListId], references: [id], onDelete: Cascade)
  movieListId Int
  userId      String
  text        String
  createdAt   DateTime  @default(now())

  @@index([movieListId])
  @@index([userId])
}

// Oscar nomination data (global per movie)
model OscarNomination {
  id              Int      @id @default(autoincrement())

  // Identity fields
  tmdbId          Int?     // Can be null if TMDB lookup failed
  imdbId          String   // Always present from CSV (e.g., "tt0019217")

  // CSV fields - full data preservation
  ceremony        Int      // 1, 2, 3... 97
  year            String   // "1927/28", "2024"
  class           String   // "Acting", "Production", "Directing"
  canonicalCategory String // "ACTOR IN A LEADING ROLE"
  category        String   // "ACTOR", "ACTRESS"
  nomId           String   // "an0051251"
  film            String   // "The Noose"
  name            String?  // Nominee name (e.g., "Richard Barthelmess")
  nominees        String?  // Full nominees string
  nomineeIds      String?  // IMDB IDs of people
  winner          Boolean  @default(false)
  detail          String?  // Additional details
  note            String?  // Notes
  citation        String?  // Citation text
  multifilmNomination Boolean @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tmdbId])
  @@index([imdbId])
  @@unique([nomId])
}

// Pre-aggregated Oscar counts for performance
model OscarMovieSummary {
  id              Int      @id @default(autoincrement())
  tmdbId          Int      @unique
  imdbId          String
  totalNominations Int     @default(0)
  totalWins       Int      @default(0)

  // Category breakdowns (JSON for flexibility)
  categoryBreakdown Json?  // { "Acting": { "nominations": 3, "wins": 1 }, ... }

  updatedAt       DateTime @updatedAt

  @@index([tmdbId])
}
